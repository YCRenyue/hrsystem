# 员工信息录入和登入功能详细需求

> **最后更新时间**: 2025-11-22
>
> **文档说明**: 本文档为HR管理系统的详细需求和开发进度跟踪文档。每次开发前请先阅读，开发完成后请更新进度。
>
> **最新更新**: 完成前端UI增强和文档整理，所有核心功能已完成并通过全面测试（87个测试全部通过）

## 📊 项目进度概览

- **整体完成度**: 70%
- **当前阶段**: 阶段四/五 - 钉钉集成与通知系统
- **下一里程碑**: 完成入职流程自动化功能

### 已完成功能模块

- [x] 项目架构搭建（100%）
- [x] 数据库设计和初始化（100%）
- [x] 基础数据模型（100%）✨ 已完成
- [x] 数据安全和权限系统（80%）✨ 已完善
- [x] 钉钉集成基础功能（70%）✨ 新增
- [x] Excel文件导入导出功能（100%）
- [x] 通知系统与定时任务（100%）✨ 新增
- [ ] 入职流程自动化功能（30%）🔄 进行中
- [x] HR管理界面（80%）✨ 已完善
- [ ] 员工自助服务（0%）

---

## 一、项目架构设计

### 1.1 技术栈选择

- **前端**：React 19 + TypeScript + Ant Design 5.x
- **后端**：Node.js 18+ / Express 5.x
- **数据库**：MySQL 8.0+
- **缓存**：Redis
- **文件处理**：SheetJS (xlsx解析)
- **钉钉集成**：钉钉开放平台API
- **部署**：Docker + 云服务器

### 1.2 项目结构

```
hrsystem/
├── frontend/          # React前端代码
├── backend/          # Node.js后端代码
├── database/         # 数据库脚本
├── docs/            # 文档
├── sample_data/     # 测试数据
└── deploy/          # 部署配置
```

### 1.3 开发规范

- **代码风格**: Airbnb JavaScript Style Guide
- **提交规范**: Conventional Commits
- **分支策略**: Git Flow
- **测试要求**: TDD，最低覆盖率50%，目标80%+

---

## 二、功能点分解和实现步骤

### 阶段一：基础环境搭建 ✅ 已完成

**估时**：2-3天 | **实际用时**：3天 | **完成度**：100%

#### 1.1 项目初始化 ✅

- [x] 创建前端项目架构 (已完成 - 2025-01-08)
  - 使用Create React App + TypeScript模板
  - 配置ESLint和Prettier
  - 配置路由和基础布局
- [x] 创建后端项目架构 (已完成 - 2025-01-08)
  - Express应用基础结构
  - 中间件配置（CORS、body-parser、helmet等）
  - 环境变量配置
- [x] 配置开发环境 (已完成 - 2025-01-08)
  - Docker Compose配置
  - 本地开发脚本
  - 热重载配置
- [x] 设置Git工作流 (已完成 - 2025-01-08)
  - Git hooks配置
  - 提交消息规范
  - 分支保护规则

#### 1.2 数据库设计和初始化 ✅

- [x] 设计员工表结构 (已完成 - 2025-01-08)
  - 设计核心字段
  - 加密字段标识
  - 索引设计
- [x] 设计部门表结构 (已完成 - 2025-01-08)
  - 树形结构设计
  - 关联关系
- [x] 设计用户权限表结构 (已完成 - 2025-01-08)
  - 三级权限设计
  - 权限粒度定义
- [x] 创建数据库初始化脚本 (已完成 - 2025-01-08)
  - SQL建表脚本
  - 初始化数据脚本
  - Sequelize迁移配置
- [x] 设置数据库连接池 (已完成 - 2025-01-08)
  - 连接池配置优化
  - 错误处理

#### 1.3 钉钉开发环境配置 ⏸️ 暂缓

- [ ] 注册钉钉开发者账号
- [ ] 创建企业内部应用
- [ ] 获取AppKey和AppSecret
- [ ] 配置回调地址

**备注**: 钉钉集成将在阶段四进行，当前暂缓。

---

### 阶段二：员工信息数据模型 ✅ 已完成

**估时**：1-2天 | **实际用时**：2天 | **完成度**：80%

#### 2.1 数据库表创建 ✅

- [x] 创建员工信息表(employees) (已完成 - 2025-01-08)
  - 基础字段：employee_id, employee_number, name_encrypted等
  - 加密字段：name_encrypted, id_card_encrypted, phone_encrypted
  - 哈希字段：name_hash, phone_hash（用于搜索）
  - 关联字段：department_id, created_by
  - 状态字段：status, data_complete
  - 时间戳：created_at, updated_at

- [x] 创建入职流程表(onboarding_processes) (已完成 - 2025-01-08)
  - 流程ID：process_id
  - 关联：employee_id
  - 状态：process_status (pending/sent/completed/timeout)
  - 通知：notification_method, sent_time
  - 表单：form_token, form_link
  - 统计：reminder_count

- [x] 创建权限管理表(users) (已完成 - 2025-01-08)
  - 用户ID：user_id
  - 角色：role (admin/hr/employee)
  - 权限：permissions (JSON)
  - 部门范围：department_scope

- [x] 创建部门表(departments) (已完成 - 2025-01-08)
  - 部门ID：department_id
  - 名称：department_name
  - 层级：parent_department_id, manager_id
  - 统计：employee_count

- [x] 创建操作日志表(operation_logs) (已完成 - 2025-01-08)
  - 日志ID：log_id
  - 操作信息：user_id, operation_type, table_name
  - 数据快照：old_values, new_values (JSON)
  - 审计：ip_address, created_at

#### 2.2 数据模型开发 🔄 进行中

- [x] 创建Employee模型类 (已完成 - 2025-01-08)
  - Sequelize模型定义
  - 字段验证规则
  - 关联关系定义

- [x] 创建OnboardingProcess模型类 (已完成 - 2025-01-08)
- [x] 创建Department模型类 (已完成 - 2025-01-08)
- [x] 创建User模型类 (已完成 - 2025-01-08)
- [x] 创建OperationLog模型类 (已完成 - 2025-01-08)

- [x] 实现基础CRUD操作 (已完成 - 2025-01-08)
  - Repository模式实现
  - 基础增删改查
  - 测试覆盖率：75%

- [ ] 实现员工状态流转逻辑 🚧 待完成
  - 状态转换规则
  - 状态验证
  - 测试用例编写

- [x] 实现数据加密/解密方法 (已完成 - 2025-01-08)
  - AES-256加密工具
  - 字段级加密
  - 哈希生成（用于搜索）
  - 测试覆盖率：90%

- [ ] 实现权限验证逻辑 🚧 进行中
  - 中间件实现（50%）
  - 角色验证
  - 数据权限过滤

---

### 阶段三：数据安全和权限系统 🔄 进行中

**估时**：2-3天 | **当前用时**：1天 | **完成度**：40%

#### 3.1 数据加密系统 ✅

- [x] 实现AES-256加密工具类 (已完成 - 2025-01-08)
  - 位置：`backend/src/utils/encryption.js`
  - 功能：加密、解密、哈希生成
  - 测试覆盖率：90%

- [x] 配置敏感字段加密规则 (已完成 - 2025-01-08)
  - 身份证号：id_card_encrypted + id_card_hash
  - 电话号码：phone_encrypted + phone_hash
  - 姓名：name_encrypted + name_hash
  - 银行卡号：bank_card_encrypted

- [x] 实现身份证号码加密存储 (已完成 - 2025-01-08)
- [x] 实现联系电话脱敏显示 (已完成 - 2025-01-08)
  - 格式：138****8888

- [x] 实现数据加密中间件 (已完成 - 2025-01-08)
  - 自动加密敏感字段
  - 自动生成哈希

- [x] 设置加密密钥管理 (已完成 - 2025-01-08)
  - 环境变量配置
  - 密钥轮换策略（文档）

#### 3.2 三级权限系统 🚧 进行中

**优先级**: 高 | **依赖**: 数据模型完成 | **预计完成**: 2025-01-16

##### 角色定义和数据范围

系统采用**基于角色和数据范围**的权限模型，支持5种用户角色：

| 角色 | 英文标识 | 数据范围 | 敏感数据权限 | 说明 |
|-----|---------|---------|-------------|------|
| 系统管理员 | admin | 全部(all) | ✅ | 完整系统权限，包括用户管理 |
| HR管理员 | hr_admin | 全部(all) | ✅ | 员工信息管理，无用户/角色管理权限 |
| 部门经理 | department_manager | 本部门(department) | ✅ (本部门) | 可查看和管理本部门员工数据 |
| 普通员工 | employee | 仅自己(self) | ✅ (仅自己) | 仅可查看和编辑个人信息 |

**数据范围说明**：
- `all`（全部）：可访问所有部门的数据，无部门限制
- `department`（本部门）：仅可访问所属部门（`department_id`）的数据
- `self`（仅自己）：仅可访问与自己员工记录（`employee_id`）关联的数据

##### 权限矩阵

| 权限标识 | 权限说明 | admin | hr_admin | dept_manager | employee |
|---------|---------|-------|----------|--------------|----------|
| **员工信息管理** |
| employees.view_all | 查看所有员工 | ✅ | ✅ | ❌ | ❌ |
| employees.view_department | 查看本部门员工 | ✅ | ✅ | ✅ | ❌ |
| employees.view_self | 查看个人信息 | ✅ | ✅ | ✅ | ✅ |
| employees.create | 创建员工档案 | ✅ | ✅ | ❌ | ❌ |
| employees.update_all | 修改所有员工信息 | ✅ | ✅ | ❌ | ❌ |
| employees.update_department | 修改本部门员工 | ✅ | ✅ | ✅ (限制) | ❌ |
| employees.update_self_limited | 修改个人信息（限定字段）| ✅ | ✅ | ✅ | ✅ |
| employees.delete | 删除员工档案 | ✅ | ✅ | ❌ | ❌ |
| employees.export | 导出员工数据 | ✅ | ✅ | ✅ (本部门) | ❌ |
| **部门管理** |
| departments.view | 查看部门信息 | ✅ | ✅ | ✅ (本部门) | ✅ (本部门) |
| departments.manage | 管理部门结构 | ✅ | ❌ | ❌ | ❌ |
| **报表功能** |
| reports.view_all | 查看全部报表 | ✅ | ✅ | ❌ | ❌ |
| reports.view_department | 查看部门报表 | ✅ | ✅ | ✅ | ❌ |
| **系统管理** |
| users.manage | 用户账号管理 | ✅ | ❌ | ❌ | ❌ |
| onboarding.manage | 入职流程管理 | ✅ | ✅ | ❌ | ❌ |

**可编辑字段范围**：

| 字段类型 | admin | hr_admin | dept_manager | employee |
|---------|-------|----------|--------------|----------|
| 基础信息（姓名、工号、入职日期）| ✅ | ✅ | ❌ | ❌ |
| 联系方式（电话、邮箱）| ✅ | ✅ | ✅ | ✅ (仅自己) |
| 部门信息 | ✅ | ✅ | ❌ | ❌ |
| 职位信息 | ✅ | ✅ | ✅ | ❌ |
| 敏感信息（身份证、银行卡）| ✅ | ✅ | ❌ | ✅ (仅自己) |
| 紧急联系人 | ✅ | ✅ | ✅ | ✅ (仅自己) |

##### 实施任务清单

###### 3.2.1 数据库结构设计 📅 待开始

- [ ] 更新users表结构
  - 新增字段：`department_id`（VARCHAR(36)，允许NULL）
  - 新增字段：`data_scope`（ENUM：'all'/'department'/'self'，默认'self'）
  - 新增字段：`can_view_sensitive`（BOOLEAN，默认FALSE）
  - 添加索引：`idx_users_department`、`idx_users_role_scope`

- [ ] 创建权限种子数据
  - 5种角色的测试用户（每种至少1个）
  - 3个测试部门（生产部、销售部、行政部）
  - 每部门1个经理 + 3个员工
  - 权限映射配置数据

###### 3.2.2 后端权限系统实现 🚧 进行中

- [ ] 创建权限常量定义
  - 文件：`backend/src/constants/permissions.js`
  - 定义15个核心权限常量
  - 权限分组（员工、部门、报表、用户）

- [x] 实现基础权限验证中间件 (部分完成 - 2025-01-08)
  - 文件：`backend/src/middleware/auth.js`
  - JWT token验证 ✅
  - 角色验证 ✅
  - 数据权限验证 🚧

- [ ] 创建细粒度权限中间件
  - 文件：`backend/src/middleware/permission.js`
  - `checkPermission(permission)` - 检查具体权限
  - `checkDataScope(resourceType)` - 验证数据范围
  - `requireDepartmentAccess(deptIdParam)` - 部门访问控制

- [ ] 增强User模型方法
  - 文件：`backend/src/models/User.js`
  - `canAccessDepartment(deptId)` - 部门访问权限检查
  - `getDataScopeFilter()` - 获取数据过滤条件
  - `canViewSensitiveData(targetUserId)` - 敏感数据访问权限

- [ ] 改造Repository层添加数据过滤
  - 文件：`backend/src/repositories/EmployeeRepository.js`
  - `findByDataScope(user, filters)` - 根据用户权限过滤
  - `canUserAccessEmployee(user, employeeId)` - 访问权限验证
  - 集成到所有查询方法

- [ ] 实现用户角色分配API
  - API端点：POST /api/users/:id/role
  - API端点：PUT /api/users/:id/department
  - 权限检查（仅admin）
  - 审计日志记录

###### 3.2.3 前端权限基础设施 📅 待开始

- [ ] 创建权限管理Context
  - 文件：`frontend/src/contexts/PermissionContext.tsx`
  - 提供：`hasPermission()`, `canViewDepartment()`, `dataScope`
  - 从登录用户信息初始化权限

- [ ] 创建权限相关组件
  - `RoleGuard.tsx` - 路由级权限守卫
  - `Can.tsx` - 条件渲染组件（用法：`<Can permission="...">...</Can>`）
  - `AccessDenied.tsx` - 无权限提示页面

- [ ] 创建自定义Hook
  - 文件：`frontend/src/hooks/usePermission.ts`
  - 封装权限检查逻辑
  - 提供便捷的权限判断方法

###### 3.2.4 UI功能集成 📅 待开始

- [ ] 更新路由配置
  - 文件：`frontend/src/App.tsx`
  - 用RoleGuard包装需要权限的路由
  - 配置每个路由的required permission

- [ ] 改造EmployeeList页面
  - 根据dataScope自动过滤员工列表
  - admin/hr_admin：显示全部 + 部门筛选器
  - department_manager：仅本部门 + 隐藏部门筛选
  - employee：重定向到个人信息页
  - 敏感数据根据can_view_sensitive显示/脱敏

- [ ] 改造EmployeeForm页面
  - 根据角色控制可编辑字段
  - 创建权限检查（仅admin/hr_admin）
  - 编辑权限检查（根据角色和数据范围）
  - 字段级权限控制（部分只读）

- [ ] 创建个人信息页面
  - 文件：`frontend/src/pages/Profile/UserProfile.tsx`
  - 显示当前用户员工信息
  - 可编辑：联系方式、紧急联系人
  - 只读：姓名、工号、部门、入职日期

- [ ] 改造Dashboard页面
  - 角色差异化显示统计数据
  - admin/hr_admin：全局统计
  - department_manager：本部门统计
  - employee：个人快捷方式

###### 3.2.5 测试覆盖 📅 待开始

- [ ] 后端权限中间件测试
  - 文件：`backend/src/__tests__/middleware/permission.test.js`
  - 各角色权限检查（15个测试）
  - 数据范围过滤（10个测试）
  - 跨部门访问拦截（5个测试）

- [ ] 前端权限组件测试
  - 文件：`frontend/src/__tests__/components/Permission.test.tsx`
  - RoleGuard组件测试
  - Can组件测试
  - usePermission Hook测试

- [ ] E2E权限测试（可选）
  - 不同角色登录流程
  - 页面访问权限验证
  - 数据过滤正确性验证

##### 技术实现要点

**后端权限中间件结构**：

```javascript
// backend/src/middleware/permission.js
exports.checkPermission = (requiredPermission) => {
  return async (req, res, next) => {
    const user = req.user; // from JWT
    if (user.hasPermission(requiredPermission)) {
      return next();
    }
    return res.status(403).json({ error: 'Permission denied' });
  };
};

exports.checkDataScope = (resourceType) => {
  return async (req, res, next) => {
    const user = req.user;
    const filter = user.getDataScopeFilter(resourceType);
    req.dataScopeFilter = filter; // 传递给后续处理
    next();
  };
};
```

**前端权限Hook使用示例**：

```typescript
// 在组件中使用
const { hasPermission, dataScope } = usePermission();

if (hasPermission('employees.create')) {
  // 显示创建按钮
}

// 或使用Can组件
<Can permission="employees.delete">
  <Button danger>删除</Button>
</Can>
```

**实施进度**：
- 整体完成度：40%
- 已完成：基础权限验证、角色定义
- 进行中：数据权限过滤
- 待开始：前端权限基础设施、UI集成

#### 3.3 操作审计系统 🚧 待开始

**优先级**: 中 | **依赖**: 权限系统完成

- [x] 实现操作日志记录 (基础完成 - 2025-01-08)
  - 模型已创建
  - 基础记录功能

- [ ] 设计敏感操作拦截 📅 计划中
  - 删除员工
  - 修改敏感信息
  - 权限变更

- [ ] 实现数据变更追踪 📅 计划中
  - Before/After对比
  - JSON diff

- [ ] 设置日志查询和分析 📅 计划中
  - 查询接口
  - 前端展示

- [ ] 实现异常操作告警 📅 计划中
  - 告警规则
  - 通知机制

- [ ] 配置日志清理策略 📅 计划中
  - 保留期限
  - 归档策略

---

### 阶段四：钉钉集成基础功能 🔄 进行中

**估时**：2-3天 | **实际用时**：1天 | **完成度**：70% | **优先级**: 高 | **依赖**: 基础环境、数据模型
**完成时间**：2025-12-02

#### 4.1 钉钉API封装 ✅ 已完成

- [x] 实现获取access_token功能 (已完成 - 2025-12-02)
  - API封装 ✅
  - Token缓存（内存缓存，7200秒有效期）✅
  - 自动刷新机制 ✅
  - 文件：`backend/src/services/DingTalkService.js`

- [x] 实现用户信息获取API (已完成 - 2025-12-02)
  - 根据userId获取用户信息 ✅
  - 根据手机号获取userId ✅
  - 错误处理和空值处理 ✅

- [ ] 实现组织架构获取API 📅 待实现
  - 部门列表同步
  - 用户列表同步
  - 增量同步

- [ ] 实现OAuth认证功能 📅 待实现
  - 登录跳转
  - 回调处理
  - Token生成

- [x] 错误处理和重试机制 (已完成 - 2025-12-02)
  - API错误处理 ✅
  - 错误日志记录 ✅
  - 优雅降级 ✅

#### 4.1.1 通知服务集成 ✅ 新增并完成

- [x] 创建NotificationService统一通知服务 (已完成 - 2025-12-02)
  - 多渠道支持（钉钉 + 邮件）✅
  - 自动降级策略 ✅
  - 批量通知发送 ✅
  - 文件：`backend/src/services/NotificationService.js`

- [x] 实现各类通知功能 (已完成 - 2025-12-02)
  - 入职登记表推送 ✅
  - 入职前提醒 ✅
  - 入职一周后欢迎消息 ✅
  - 新员工培训日程提醒 ✅
  - 社保缴纳情况推送 ✅
  - 劳动合同到期提醒 ✅
  - 每月统计推送（出差补助、食堂工资）✅

#### 4.1.2 定时任务调度系统 ✅ 新增并完成

- [x] 创建SchedulerService定时任务服务 (已完成 - 2025-12-02)
  - 使用node-cron实现定时任务 ✅
  - 6个自动化任务调度 ✅
  - 手动触发接口 ✅
  - 文件：`backend/src/services/SchedulerService.js`

- [x] 实现自动化任务 (已完成 - 2025-12-02)
  - 每日9:00 - 入职当天推送登记表 ✅
  - 每日10:00 - 入职前3天提醒 ✅
  - 每周一9:00 - 入职一周后欢迎消息 ✅
  - 每日8:00 - 培训日程提醒 ✅
  - 每日9:00 - 合同到期提醒（30天前）✅
  - 每月1日10:00 - 月度统计推送 ✅

- [x] 集成到应用启动流程 (已完成 - 2025-12-02)
  - 在app.js中启动调度器 ✅
  - 支持ENABLE_SCHEDULER环境变量控制 ✅

#### 4.2 用户认证系统

- [ ] 实现钉钉OAuth登录流程
  - 前端登录按钮
  - OAuth跳转
  - 回调处理

- [ ] 实现JWT token生成和验证
  - Token生成
  - Token验证中间件
  - Token刷新

- [ ] 实现会话管理
  - Redis会话存储
  - 会话过期
  - 单点登录

- [ ] 实现权限中间件
  - 已在3.2实现
  - 集成钉钉用户信息

---

### 阶段五：Excel文件导入导出功能 ✅ 已完成

**估时**：3-4天 | **实际用时**：2小时 | **完成度**：100%
**完成时间**：2025-11-22

#### 5.1 文件上传功能 ✅

- [x] 前端文件上传组件 (已完成 - 2025-11-22)
  - Ant Design Upload组件
  - 单文件上传
  - 文件类型限制

- [x] 后端文件接收和存储 (已完成 - 2025-11-22)
  - Multer中间件配置
  - 内存存储（memoryStorage）
  - 自动清理

- [x] 文件格式验证(.xlsx, .xls) (已完成 - 2025-11-22)
  - MIME类型检查
  - 仅允许Excel文件

- [x] 文件大小限制(10MB) (已完成 - 2025-11-22)
  - 后端限制10MB
  - 错误提示

#### 5.2 Excel解析功能 ✅

- [x] 安装和配置ExcelJS库 (已完成 - 2025-11-22)
  - ExcelJS替代SheetJS
  - 更好的性能和功能

- [x] 实现Excel文件读取 (已完成 - 2025-11-22)
  - 读取第一个工作表
  - 逐行解析
  - Buffer方式处理

- [x] 实现数据格式验证 (已完成 - 2025-11-22)
  - 跳过空行
  - 必填项检查
  - 数据类型验证

- [x] 实现必填字段检查 (已完成 - 2025-11-22)
  - 姓名、工号必填
  - 错误行号记录
  - 详细错误信息

- [x] 实现数据类型转换 (已完成 - 2025-11-22)
  - 日期格式智能转换（Excel序列日期、ISO格式）
  - 字符串清理（trim）
  - 状态值验证

#### 5.3 数据验证和清洗 ✅

- [x] 手机号格式验证 (已完成 - 2025-11-22)
  - 通过加密存储自动处理
  - 11位手机号

- [x] 邮箱格式验证 (已完成 - 2025-11-22)
  - Sequelize内置验证

- [x] 身份证号格式验证 (已完成 - 2025-11-22)
  - 18位身份证号
  - 加密存储

- [x] 工号唯一性检查 (已完成 - 2025-11-22) ⭐ **核心功能**
  - 数据库查询验证
  - 重复工号拒绝导入
  - 返回详细错误信息

- [x] 姓名加密处理 (已完成 - 2025-11-22)
  - 自动加密存储

- [x] 部门ID验证 (已完成 - 2025-11-22)
  - 外键关联验证

#### 5.4 批量导入处理 ✅

- [x] 实现逐行处理 (已完成 - 2025-11-22)
  - 逐条处理，部分失败不影响其他
  - 错误行继续处理

- [x] 实现错误数据收集 (已完成 - 2025-11-22)
  - 错误信息收集（包含行号）
  - 错误原因记录
  - 完整错误报告

- [x] 实现导入结果报告 (已完成 - 2025-11-22)
  - 成功/失败统计
  - 详细错误列表
  - JSON格式返回

#### 5.5 Excel导出功能 ✅

- [x] 实现员工数据导出 (已完成 - 2025-11-22)
  - 导出所有字段
  - 支持筛选条件（部门、状态等）
  - 权限控制（HR/Admin）
  - 敏感数据脱敏（根据权限）

- [x] 导出文件格式化 (已完成 - 2025-11-22)
  - 标题行加粗
  - 灰色背景
  - 列宽自适应
  - 日期格式化

#### 5.6 测试覆盖 ✅

- [x] 编写导入导出测试 (已完成 - 2025-11-22)
  - 正常导入测试
  - **重复数据导入测试**（核心）
  - 混合有效/无效数据测试
  - 空文件测试
  - 权限测试
  - 导出功能测试
  - **测试覆盖率：85%+**
  - **12个测试用例全部通过**

#### 5.5 钉钉账号绑定

- [ ] 根据手机号匹配钉钉用户
  - 调用钉钉API
  - 模糊匹配

- [ ] 实现自动绑定功能
  - 绑定逻辑
  - 绑定确认

- [ ] 处理绑定失败情况
  - 手动绑定
  - 跳过绑定

- [ ] 生成绑定结果报告
  - 绑定成功率
  - 未绑定列表

---

### 阶段六：入职流程自动化功能 📅 待开始

**估时**：3-4天 | **优先级**: 高 | **依赖**: 钉钉集成、数据模型

#### 6.1 HR员工预录入功能

- [ ] 设计HR员工预录入表单
  - 姓名、工号输入
  - 入职日期选择
  - 部门选择下拉
  - 职位输入
  - 预期完成时间

- [ ] 实现员工基础信息保存
  - API：POST /api/employees/preregister
  - 数据验证
  - 保存到数据库

- [ ] 实现工号唯一性验证
  - 前端实时验证
  - 后端唯一性检查

- [ ] 实现入职流程自动创建
  - 创建onboarding_process记录
  - 生成form_token
  - 状态设为pending

- [ ] 员工状态设置为"待完善"
  - status = 'pending'
  - data_complete = false

#### 6.2 定时任务系统

- [ ] 安装和配置任务调度器(node-cron)
  - 依赖安装
  - 定时任务配置

- [ ] 实现入职日期监控任务
  - 每日00:00执行
  - 查询当日入职员工

- [ ] 实现每日任务执行逻辑
  - 获取待推送员工
  - 批量发送通知
  - 更新流程状态

- [ ] 实现任务执行日志记录
  - 执行时间
  - 处理结果
  - 错误记录

- [ ] 实现任务失败重试机制
  - 重试次数限制
  - 指数退避

#### 6.3 入职登记表动态生成

- [ ] 设计完整的入职登记表单
  - 基于员工信息表结构
  - 分步表单设计
  - 必填/可选标记

- [ ] 实现表单动态链接生成
  - 唯一token生成
  - URL拼接
  - 短链接生成（可选）

- [ ] 实现表单访问权限控制
  - Token验证
  - 员工身份验证
  - 防止重复提交

- [ ] 实现表单有效期管理
  - 默认7天有效
  - 过期提醒
  - 延期功能

- [ ] 实现表单提交数据合并
  - 合并预录入数据
  - 更新员工记录
  - 状态更新为completed

#### 6.4 多渠道消息推送功能

- [ ] 实现钉钉工作通知发送（主要方式）
  - 工作通知API
  - 消息模板
  - 链接跳转

- [ ] 集成短信API发送链接（备用方式）
  - 短信服务商选择
  - API集成
  - 短信模板

- [ ] 设计入职登记表推送消息模板
  - 欢迎语
  - 链接说明
  - 截止日期提醒

- [ ] 实现推送方式优先级策略
  - 优先钉钉
  - 钉钉失败则短信
  - 全失败则HR手动

- [ ] 实现消息发送状态跟踪
  - 发送成功/失败
  - 已读/未读（钉钉）
  - 点击统计

- [ ] 实现发送失败自动切换渠道
  - 异常捕获
  - 自动降级
  - 通知HR

- [ ] 实现HR手动推送通知功能
  - 前端重发按钮
  - 手动选择渠道
  - 发送记录

- [ ] 实现消息发送日志记录
  - 发送时间
  - 发送渠道
  - 发送结果

#### 6.5 员工自主信息完善

- [ ] 设计员工信息完善表单（基于Excel模板）
  - 多步骤表单
  - 字段验证
  - 文件上传

- [ ] 实现用户登录验证（钉钉账号）
  - 钉钉免登
  - Token验证
  - 权限检查

- [ ] 实现表单预填充（HR录入的基础信息）
  - 只读字段展示
  - 可编辑字段
  - 数据回显

- [ ] 实现敏感信息加密提交
  - 前端加密（可选）
  - 后端加密存储
  - HTTPS传输

- [ ] 实现表单数据验证和文件上传
  - 实时验证
  - 文件类型检查
  - 文件大小限制

- [ ] 实现信息提交和数据合并
  - 数据合并逻辑
  - 冲突处理
  - 事务保证

- [ ] 实现完成状态自动更新
  - status = 'completed'
  - data_complete = true
  - 完成时间记录

- [ ] 实现表单访问权限控制（只能填写自己的信息）
  - Token绑定员工ID
  - 跨员工访问拦截
  - 审计日志

---

### 阶段七：HR兜底录入功能 📅 待开始

**估时**：2天 | **优先级**: 中 | **依赖**: 员工管理界面

#### 7.1 完整员工信息录入

- [ ] 设计完整的员工信息录入表单
  - 所有字段
  - 分组展示
  - 智能验证

- [ ] 实现所有字段的数据验证
  - 必填项检查
  - 格式验证
  - 逻辑验证

- [ ] 实现钉钉账号手动绑定
  - 搜索钉钉用户
  - 手动选择
  - 绑定确认

- [ ] 实现直接状态设置为"已完善"
  - 跳过入职流程
  - 直接激活账号

- [ ] 实现操作权限控制
  - 仅HR可用
  - 操作审计

#### 7.2 批量操作和管理

- [ ] 实现待完善员工列表显示
  - 列表筛选
  - 状态标记
  - 超时提醒

- [ ] 实现批量提醒功能
  - 批量选择
  - 重发通知
  - 发送记录

- [ ] 实现超时员工标记
  - 超时规则
  - 自动标记
  - 提醒HR

- [ ] 实现手动完善操作
  - 快速录入
  - 批量导入
  - 数据校验

- [ ] 实现状态批量更新
  - 批量激活
  - 批量停用
  - 确认提示

---

### 阶段八：员工登入功能 📅 待开始

**估时**：2天 | **优先级**: 中 | **依赖**: 钉钉集成、权限系统

#### 8.1 登录页面开发

- [ ] 设计钉钉登录页面
  - UI设计
  - Logo和品牌
  - 登录按钮

- [ ] 实现钉钉扫码登录
  - PC端扫码
  - 跳转授权

- [ ] 实现移动端适配
  - 响应式设计
  - 钉钉内免登

- [ ] 实现登录状态保持
  - Remember Me
  - Token刷新
  - 自动登录

#### 8.2 个人信息页面

- [ ] 设计个人信息展示页面
  - 信息卡片
  - 头像显示
  - 部门信息

- [ ] 实现部门信息显示
  - 部门名称
  - 上级部门
  - 部门负责人

- [ ] 实现个人信息编辑(限制字段)
  - 可编辑字段：电话、邮箱、地址
  - 只读字段：姓名、工号、入职日期
  - 修改审批（可选）

- [ ] 实现密码修改功能
  - 原密码验证
  - 新密码强度
  - 修改成功提示

#### 8.3 权限控制

- [ ] 实现基于角色的路由守卫
  - 路由权限配置
  - 未授权跳转
  - 前端路由拦截

- [ ] 实现API权限控制
  - 中间件集成
  - 角色验证
  - 错误响应

- [ ] 实现数据权限过滤
  - 个人数据过滤
  - 部门数据过滤
  - 敏感信息隐藏

- [ ] 实现操作日志记录
  - 登录日志
  - 操作日志
  - 审计追踪

---

### 阶段九：HR管理界面 ✅ 已完成

**估时**：2-3天 | **实际用时**：2天 | **完成度**：80%
**完成时间**：2025-11-22

#### 9.1 员工列表管理（HR专用） ✅ 已完成

**优先级**: 高 | **依赖**: 基础API完成

- [x] 实现员工信息列表展示 (完成 - 2025-11-22)
  - 前端：`frontend/src/pages/Employee/EmployeeList.tsx`
  - 表格组件 ✅
  - 分页功能 ✅（支持10/20/50/100条/页）
  - Card布局优化 ✅
  - 响应式设计 ✅
  - 数据加载状态显示 ✅

- [x] 实现多维度搜索和筛选功能 (已完成 - 2025-11-22)
  - [x] 按姓名、工号、邮箱搜索 ✅
  - [x] 按部门筛选（支持搜索） ✅
  - [x] 按员工状态筛选 ✅
  - [x] 按入职时间范围筛选 ✅
  - [x] 筛选条件UI优化（Card分组） ✅
  - [ ] 高级搜索面板 📅 待实现（可选）

- [x] 实现分页和排序功能 (已完成 - 2025-11-22)
  - 前端分页 ✅
  - 多种分页选项 ✅
  - 后端分页 🚧 待优化
  - 排序功能 📅 待实现

- [ ] 实现员工信息查看和编辑权限 📅 待实现
  - 详情模态框
  - 编辑表单
  - 权限检查

- [ ] 实现员工状态管理 📅 待实现
  - 状态切换
  - 状态流转规则
  - 批量更新

- [ ] 实现入职流程状态查看 📅 待实现
  - 流程进度
  - 时间线展示
  - 状态更新

- [ ] 实现敏感信息权限控制展示 📅 待实现
  - 数据脱敏
  - 权限验证
  - 解密查看（需授权）

- [ ] 实现批量操作权限控制 📅 待实现
  - 批量选择
  - 批量删除（软删除）
  - 批量导出

#### 9.2 入职流程管理 📅 待开始

- [ ] 实现入职流程列表展示
- [ ] 实现流程状态监控
- [ ] 实现手动重发登记表功能
- [ ] 实现流程超时处理
- [ ] 实现批量提醒功能

#### 9.3 批量操作功能 📅 待开始

- [ ] 实现批量选择
- [ ] 实现批量删除
- [ ] 实现批量状态更新
- [ ] 实现数据导出功能
- [ ] 实现批量消息推送

#### 9.4 部门管理 ✅ 已完成

- [x] 实现部门树形结构显示 (完成 - 2025-11-22)
  - 前端：`frontend/src/pages/Department/DepartmentList.tsx`
  - 层级展示 ✅
  - 部门统计 ✅
- [x] 实现部门增删改操作 (完成 - 2025-11-22)
  - 添加部门 ✅
  - 编辑部门 ✅
  - 删除部门 ✅
- [x] 实现部门员工分配 (完成 - 2025-11-22)
- [x] 实现部门负责人设置 (完成 - 2025-11-22)

---

### 阶段十：测试和优化 📅 待开始

**估时**：2天 | **优先级**: 高 | **依赖**: 所有功能完成

#### 10.1 功能测试

- [x] 单元测试编写 (部分完成)
  - 后端测试覆盖率：75%
  - 前端测试覆盖率：0%（待补充）

- [ ] 集成测试
  - API集成测试
  - 端到端流程测试

- [ ] 用户体验测试
  - 流程完整性
  - 错误提示友好性
  - 性能体验

- [ ] 性能测试
  - 并发测试
  - 大数据量测试
  - 响应时间测试

#### 10.2 优化和修复

- [ ] 性能优化
  - 数据库查询优化
  - 前端渲染优化
  - 缓存策略

- [ ] Bug修复
  - 已知问题修复
  - 边缘情况处理

- [ ] 安全加固
  - 安全扫描
  - 漏洞修复
  - 渗透测试

- [ ] 文档完善
  - API文档
  - 用户手册
  - 部署文档

---

## 三、关键技术实现要点

### 3.1 入职流程核心逻辑

**文件位置**: `backend/src/services/OnboardingService.js`

```javascript
// 预期实现结构
const createEmployeeBasicInfo = async (employeeData) => {
  // 1. 创建员工基础记录
  // 2. 生成唯一工号
  // 3. 创建入职流程记录
  // 4. 设置状态为"待完善"
}

const dailyOnboardingTask = async () => {
  // 1. 查询当日入职员工
  // 2. 生成入职登记表链接
  // 3. 推送钉钉消息
  // 4. 更新流程状态
}
```

### 3.2 动态表单生成

**文件位置**: `backend/src/services/FormService.js`

```javascript
// 预期实现结构
const generateOnboardingForm = async (employeeId) => {
  // 1. 生成唯一表单ID
  // 2. 预填充基础信息
  // 3. 设置表单有效期
  // 4. 返回访问链接
}
```

### 3.3 钉钉消息推送结构

**文件位置**: `backend/src/services/DingTalkService.js`

```javascript
// 预期实现结构
const sendOnboardingNotification = async (employeeInfo) => {
  // 1. 构建消息模板
  // 2. 发送工作通知
  // 3. 记录发送状态
  // 4. 设置重试机制
}
```

### 3.4 Excel解析核心代码结构

**文件位置**: `backend/src/services/ExcelService.js`

```javascript
// 预期实现结构
const parseExcelFile = async (filePath) => {
  // 1. 读取Excel文件
  // 2. 验证数据格式
  // 3. 清洗和转换数据
  // 4. 返回解析结果
}
```

### 3.5 钉钉API集成要点

**文件位置**: `backend/src/integrations/dingtalk/api.js`

```javascript
// 预期实现结构
const DingTalkAPI = {
  getAccessToken: async () => {},
  getUserInfo: async (code) => {},
  getDepartments: async () => {},
  bindUser: async (userId, employeeId) => {},
  sendWorkNotification: async (userId, message) => {}
}
```

### 3.6 数据加密核心实现

**文件位置**: `backend/src/utils/encryption.js` ✅ 已实现

```javascript
// 已实现结构
const EncryptionService = {
  encryptSensitiveData: async (data, fieldName) => {
    // AES-256加密敏感数据
  },
  decryptSensitiveData: async (encryptedData, fieldName) => {
    // 解密敏感数据
  },
  generateHash: (data) => {
    // 生成哈希用于搜索
  },
  maskPhoneNumber: (phone) => {
    // 手机号脱敏显示
    return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  }
}
```

### 3.7 权限验证中间件

**文件位置**: `backend/src/middleware/auth.js` 🚧 进行中

```javascript
// 预期实现结构
const PermissionMiddleware = {
  checkUserRole: (requiredRole) => {
    return async (req, res, next) => {
      // 验证用户角色权限
    }
  },
  checkDataAccess: (resourceType) => {
    return async (req, res, next) => {
      // 验证数据访问权限
    }
  },
  logOperation: async (userId, operation, data) => {
    // 记录操作日志
  }
}
```

### 3.8 多渠道消息推送

**文件位置**: `backend/src/services/NotificationService.js`

```javascript
// 预期实现结构
const NotificationService = {
  sendDingTalkMessage: async (userId, message) => {
    // 钉钉消息推送
  },
  sendSMSMessage: async (phone, message) => {
    // 短信推送
  },
  sendWithFallback: async (employee, message) => {
    // 多渠道推送，失败自动切换
  }
}
```

---

## 四、部署和上线计划

### 4.1 开发环境部署 ✅

- [x] 设置开发环境Docker配置 (已完成)
- [x] 配置开发数据库 (已完成)
- [x] 设置热重载和调试 (已完成)

### 4.2 测试环境部署 📅 待开始

- [ ] 设置测试环境
- [ ] 配置CI/CD流程
- [ ] 自动化测试集成

### 4.3 生产环境部署 📅 待开始

- [ ] 云服务器配置
- [ ] 域名和SSL证书配置
- [ ] 数据库备份策略
- [ ] 监控和日志系统

---

## 五、风险评估和应对

### 5.1 技术风险

| 风险 | 级别 | 应对措施 | 状态 |
|------|------|----------|------|
| 钉钉API限流 | 中 | 实现请求缓存和重试机制 | 📅 计划中 |
| 大文件处理 | 中 | 实现分批处理和进度显示 | 📅 计划中 |
| 数据安全 | 高 | 实现数据加密和访问控制 | ✅ 已实现 |
| 并发问题 | 中 | 使用事务和锁机制 | 📅 计划中 |
| 数据备份 | 高 | 自动备份策略 | 📅 待实现 |

### 5.2 业务风险

| 风险 | 级别 | 应对措施 | 状态 |
|------|------|----------|------|
| 数据准确性 | 高 | 多层数据验证 | 🔄 进行中 |
| 用户体验 | 中 | 充分的测试和反馈收集 | 📅 计划中 |
| 系统稳定性 | 高 | 完善的错误处理和恢复机制 | 🔄 进行中 |
| 权限漏洞 | 高 | 安全审计和渗透测试 | 📅 待开始 |

---

## 六、成功标准

### 6.1 功能性指标

- [ ] HR预录入成功率 > 98%
- [ ] 入职登记表推送成功率 > 95%
- [ ] 员工自主完善率 > 85%
- [ ] Excel导入成功率 > 95%
- [ ] 钉钉账号绑定成功率 > 90%
- [ ] 多渠道推送切换成功率 > 98%
- [ ] 定时任务执行准确率 > 99%

### 6.2 安全性指标

- [x] 敏感数据加密率 100% ✅
- [ ] 权限验证覆盖率 100% (当前 40% → 目标 100%)
  - 已完成：基础角色验证（40%）
  - 待完成：数据范围过滤、细粒度权限检查（60%）
- [ ] 数据访问控制完整性 100%
  - 所有API端点必须有权限检查
  - 所有数据查询必须应用数据范围过滤
- [ ] 零SQL注入漏洞 (待验证)
- [ ] 零敏感信息泄露 (待验证)
- [ ] 操作审计日志完整性 100% (当前 30%)

### 6.3 性能指标

- [ ] 系统响应时间 < 2秒
- [ ] 大文件上传处理时间 < 30秒
- [ ] 并发用户支持 > 100人
- [ ] 数据库查询优化 > 95%

### 6.4 用户体验指标

- [ ] 用户满意度 > 90%
- [ ] 界面易用性评分 > 4.5/5
- [ ] 移动端适配完成度 100%
- [ ] 错误提示友好度 > 95%

---

## 七、开发进度记录

### 最近更新 (Latest Updates)

#### 2025-12-02
- [x] 实现钉钉API集成服务（完成时间：2025-12-02）
  - **DingTalkService服务**：完整的钉钉API封装
    - Access Token自动获取和刷新（7200秒缓存）
    - 工作通知发送（文本、Markdown、链接、OA消息）
    - 用户信息查询（根据userId或手机号）
    - 完整的错误处理和日志记录
  - **NotificationService服务**：统一通知服务
    - 多渠道支持：钉钉（主）+ 邮件（备）
    - 自动降级策略：钉钉失败自动切换邮件
    - 批量通知发送
    - 8种预定义通知类型：
      - 入职登记表推送
      - 入职前提醒（3天前）
      - 入职一周后欢迎消息
      - 新员工培训日程提醒
      - 社保缴纳情况推送
      - 劳动合同到期提醒（30天前）
      - 每月出差补助统计推送
      - 每月食堂工资统计推送
  - **SchedulerService服务**：定时任务调度系统
    - 基于node-cron的任务调度
    - 6个自动化任务：
      - 每日9:00 - 入职当天推送登记表
      - 每日10:00 - 入职前3天提醒
      - 每周一9:00 - 入职一周后欢迎消息
      - 每日8:00 - 培训日程提醒
      - 每日9:00 - 合同到期提醒
      - 每月1日10:00 - 月度统计推送
    - 支持手动触发任务（测试用）
    - 可通过ENABLE_SCHEDULER环境变量控制
  - **配置和测试**：
    - 更新.env.example添加钉钉和SMTP配置
    - 创建logger工具模块（支持多级别日志）
    - 编写完整的单元测试（20+测试用例）
    - 所有测试通过
  - **前端优化**：
    - 修改员工列表页面：删除按钮改为查看按钮
    - 保留编辑按钮（需要权限）

#### 2025-11-22
- [x] 完成前端UI全面增强（完成时间：2025-11-22）
  - **MainLayout优化**：改进导航结构，添加用户信息显示，优化响应式布局
  - **Dashboard完善**：添加统计卡片（员工总数、部门数量、待入职等），添加快捷操作按钮
  - **EmployeeList增强**：
    - 完整的搜索功能（姓名、工号、邮箱）
    - 多维度筛选（部门下拉、状态筛选、日期范围选择）
    - 优化分页（支持10/20/50/100条/页）
    - 改进表格布局和Card设计
  - **EmployeeForm改进**：优化字段验证，改进布局和用户体验
  - **DepartmentList实现**：添加完整的部门管理界面

- [x] 数据库架构完善（完成时间：2025-11-22）
  - 创建标准化迁移脚本（`backend/src/db/migrations/01-create-initial-tables.js`）
  - 优化种子数据脚本（`backend/src/db/seed.js`）
  - 添加数据库重置工具（`backend/src/db/reset-database.js`）
  - 添加数据库验证工具（`backend/src/db/verify.js`）
  - 改进错误处理和事务管理

- [x] 示例数据国际化（完成时间：2025-11-22）
  - 所有示例Excel文件重命名为英文：
    - 员工信息表.xlsx → employees.xlsx
    - 部门信息表.xlsx → departments.xlsx
    - 考勤记录表.xlsx → attendance_records.xlsx
    - 年假管理表.xlsx → annual_leave.xlsx
    - 等9个文件全部重命名
  - 更新sample_data/README.md和import_template_guide.md
  - 提高项目国际化兼容性

- [x] 文档整理和优化（完成时间：2025-11-22）
  - 删除重复/过时文档目录：
    - database/tables/ 下所有SQL文件（已迁移到migrations）
    - docs/ 下所有架构文档（已整合到CLAUDE.md）
  - CLAUDE.md完全中文化：
    - 3600+行完整的中文开发指南
    - 添加"开发前必读规则"章节
    - 详细的TDD工作流说明
    - 完整的技术栈和最佳实践
  - 建立CLAUDE.md作为唯一可信文档来源

- [x] 测试覆盖率提升（完成时间：2025-11-22）
  - 后端测试覆盖率：85%+
  - 87个测试全部通过
  - 新增员工导入导出测试（12个测试用例）
  - 重复数据检测测试覆盖
  - 所有核心CRUD操作测试完成

#### 2025-01-09
- [x] 翻译CLAUDE.md到中文并添加开发规则
  - 完整翻译所有内容到中文
  - 添加"开发前必读规则"章节
  - 强调每次开发前阅读requirement.md，开发后更新进度
- [x] 重命名sample_data文件为英文
  - 所有测试Excel文件名改为英文
  - 更新README.md中的文件名引用
  - 便于项目国际化和测试
- [x] 完善requirement.md文档结构
  - 添加项目进度概览
  - 详细记录每个阶段的完成情况
  - 添加风险评估、成功标准、问题追踪系统
  - 文档从1.0升级到2.0版本
- [x] 完善员工管理页面筛选功能
  - 添加部门筛选下拉框（支持搜索）
  - 添加入职日期范围选择器
  - 优化UI布局，使用Card组件分组
  - 添加更多分页选项（10/20/50/100）
  - 优化筛选交互体验

#### 2025-01-08
- [x] 完成数据库表设计和创建
- [x] 实现基础数据模型（Employee, Department, User等）
- [x] 实现AES-256加密工具
- [x] 实现基础权限验证中间件
- [x] 创建员工管理前端页面基础框架

#### 2025-01-07
- [x] 项目初始化
- [x] Docker环境配置
- [x] 数据库连接配置

### 下一步计划 (Next Steps)

**本周目标** (2025-01-09 至 2025-01-15):
1. 完成员工管理页面的搜索和筛选功能
2. 实现Excel文件导入基础功能
3. 完善权限验证系统
4. 提升测试覆盖率到60%+

**本月目标** (2025-01):
1. 完成阶段三：数据安全和权限系统（100%）
2. 完成阶段四：钉钉集成基础功能（100%）
3. 完成阶段五：Excel文件导入功能（100%）
4. 启动阶段六：入职流程自动化功能（50%）

---

## 八、问题追踪 (Issues)

### 🔴 高优先级

1. **权限系统数据权限过滤未完成**
   - 状态：进行中
   - 负责人：待分配
   - 预计完成：2025-01-12

2. **测试覆盖率偏低**
   - 状态：待处理
   - 当前覆盖率：后端75%，前端0%
   - 目标：80%+

### 🟡 中优先级

1. **前端性能优化**
   - 大列表渲染优化
   - 懒加载实现

2. **日志系统完善**
   - 操作日志完整性
   - 日志查询功能

### 🟢 低优先级

1. **文档补充**
   - API文档
   - 用户手册

---

## 九、附录

### A. 相关文档

- [项目需求说明书](./项目需求说明书.md) - 高层次需求
- [需求分析文档](./analysis.md) - 详细功能分析
- [数据库设计文档](./docs/database.md) - 数据库详细设计
- [API接口文档](./docs/api.md) - API规范
- [开发指南](./CLAUDE.md) - 开发规范和指导

### B. 测试数据

- 样本数据位置：`sample_data/`
- 员工信息：`sample_data/employees.xlsx`
- 部门信息：`sample_data/departments.xlsx`
- 其他测试数据参见：`sample_data/README.md`

### C. 环境配置

**开发环境要求**:
- Node.js 18+
- MySQL 8.0+
- Redis 6+
- Docker 20+

**关键环境变量**:
- `ENCRYPTION_KEY`: 数据加密密钥
- `JWT_SECRET`: JWT密钥
- `DINGTALK_APP_KEY`: 钉钉AppKey
- `DINGTALK_APP_SECRET`: 钉钉AppSecret

---

### 阶段十一：智能体问答系统 📅 待开始

**估时**：5-7天 | **优先级**: 高 | **依赖**: 基础功能完成
**目标**：基于知识库的智能问答服务，支持语音与文字交互

#### 11.1 知识库建设 📅 待开始

**优先级**: 高 | **依赖**: 无

- [ ] 设计知识库数据结构
  - 创建knowledge_base表
  - 字段：知识点ID、分类、标题、内容、关键词、创建时间
  - 支持全文搜索索引

- [ ] 整理公司规章制度文档
  - 考勤制度（上下班时间、迟到早退规则、请假流程）
  - 社保与公积金制度（缴纳比例、办理流程、查询方式）
  - 假期规则（年假、病假、事假、婚假、产假等计算规则）
  - 薪酬发放流程（发薪日期、薪资构成、个税计算）
  - 公司规章制度（保密协议、行为准则、奖惩制度）

- [ ] 构建FAQ问答对
  - 至少50个常见问题
  - 标准答案模板
  - 关键词标签

- [ ] 实现知识库管理后台
  - 知识点增删改查
  - 分类管理
  - 搜索测试功能
  - 权限：仅admin和hr_admin可编辑

#### 11.2 智能问答引擎 📅 待开始

**优先级**: 高 | **依赖**: 知识库建设完成

- [ ] 选择AI模型集成方案
  - 方案A：接入第三方LLM API（OpenAI/Claude/通义千问等）
  - 方案B：本地部署小模型（LLaMA/ChatGLM等）
  - 方案C：基于规则的关键词匹配（快速原型）
  - **推荐**：先实现方案C，后期升级到方案A

- [ ] 实现问答服务核心逻辑
  - 文件：`backend/src/services/QAService.js`
  - 分词和关键词提取
  - 知识库检索（全文搜索 + 相似度匹配）
  - 答案生成和格式化
  - 上下文管理（支持多轮对话）

- [ ] 实现语音识别功能（可选）
  - 集成语音识别API（阿里云/百度/讯飞）
  - 支持中文语音输入
  - 语音转文字
  - 噪音处理

- [ ] 实现语音合成功能（可选）
  - 集成TTS服务
  - 文字转语音
  - 自然语音播报

- [ ] 实现多轮对话管理
  - 会话ID生成
  - 上下文保存（Redis）
  - 对话历史记录
  - 会话超时管理

#### 11.3 前端悬浮窗口组件 📅 待开始

**优先级**: 高 | **依赖**: 问答引擎完成

- [ ] 创建悬浮聊天按钮组件
  - 文件：`frontend/src/components/ChatBot/FloatingButton.tsx`
  - 固定在右下角
  - 圆形图标（机器人/消息图标）
  - 未读消息红点提示
  - 支持拖拽位置（可选）

- [ ] 创建聊天窗口组件
  - 文件：`frontend/src/components/ChatBot/ChatWindow.tsx`
  - 卡片式设计，宽度400px，高度600px
  - 标题栏：显示"智能助手"，最小化/关闭按钮
  - 消息列表：用户消息（右侧）、机器人消息（左侧）
  - 输入框：文本输入 + 发送按钮 + 语音按钮（可选）
  - 快捷问题按钮（常见问题快速提问）
  - 打字动画效果

- [ ] 实现文字输入交互
  - 支持Enter发送（Shift+Enter换行）
  - 消息发送时禁用输入
  - 实时显示加载状态
  - 错误提示友好

- [ ] 实现语音输入交互（可选）
  - 长按录音，松开发送
  - 录音时长显示
  - 录音波形动画
  - 语音识别结果预览

- [ ] 实现消息渲染
  - 支持Markdown格式
  - 代码高亮
  - 链接可点击
  - 图片显示（如流程图）
  - 消息时间戳

- [ ] 实现历史记录功能
  - 本地缓存对话历史（LocalStorage）
  - 清空历史记录按钮
  - 历史记录查看

- [ ] 响应式适配
  - 移动端全屏显示
  - PC端悬浮窗口
  - 自适应布局

#### 11.4 API接口开发 📅 待开始

**优先级**: 高 | **依赖**: 问答引擎完成

- [ ] 实现问答API端点
  - POST /api/qa/ask - 发送问题，返回答案
  - GET /api/qa/history - 获取对话历史
  - DELETE /api/qa/history/:sessionId - 清空对话历史
  - GET /api/qa/suggested-questions - 获取推荐问题列表

- [ ] 实现语音相关API（可选）
  - POST /api/qa/speech-to-text - 语音转文字
  - POST /api/qa/text-to-speech - 文字转语音

- [ ] 实现知识库管理API
  - GET /api/knowledge - 获取知识点列表
  - POST /api/knowledge - 创建知识点
  - PUT /api/knowledge/:id - 更新知识点
  - DELETE /api/knowledge/:id - 删除知识点
  - GET /api/knowledge/categories - 获取分类列表

- [ ] 权限控制
  - 所有用户可提问
  - 仅admin/hr_admin可管理知识库
  - 记录问答日志用于优化

#### 11.5 钉钉集成问答 📅 待开始

**优先级**: 中 | **依赖**: 智能问答引擎完成

- [ ] 实现钉钉机器人消息接收
  - 接收@机器人的消息
  - 消息格式解析
  - 用户身份识别

- [ ] 实现钉钉机器人消息回复
  - 调用问答引擎
  - 格式化回复内容
  - 支持富文本消息（卡片、链接）

- [ ] 实现钉钉群聊智能问答
  - 在群聊中@机器人提问
  - 自动回复答案
  - 支持多人同时提问

#### 11.6 测试和优化 📅 待开始

**优先级**: 高 | **依赖**: 功能开发完成

- [ ] 编写单元测试
  - 知识库检索测试
  - 关键词匹配测试
  - 问答逻辑测试

- [ ] 编写集成测试
  - API端点测试
  - 前端交互测试
  - 钉钉机器人测试

- [ ] 性能优化
  - 知识库索引优化
  - 搜索响应时间 < 2秒
  - 并发支持 > 100人

- [ ] 用户体验优化
  - 答案准确率测试
  - 错误提示优化
  - UI/UX改进

---

### 阶段十二：其他业务数据表管理 📅 待开始

**估时**：4-5天 | **优先级**: 中 | **依赖**: 员工管理完成
**目标**：实现年假、社保公积金、出差补助、就餐记录等业务数据的管理

#### 12.1 年假管理模块 📅 待开始

**优先级**: 高 | **依赖**: 员工管理、假期报表

- [ ] 设计annual_leave表结构
  - 字段：年假ID、员工ID、年度、应休天数、已休天数、剩余天数
  - 自动计算规则（根据入职时间）
  - 有效期管理

- [ ] 实现年假API
  - GET /api/annual-leave - 获取年假列表（支持筛选）
  - GET /api/annual-leave/:id - 获取单条记录
  - POST /api/annual-leave - 创建年假记录
  - PUT /api/annual-leave/:id - 更新记录
  - GET /api/annual-leave/employee/:employeeId - 查询员工年假
  - POST /api/annual-leave/calculate - 自动计算年假天数

- [ ] 创建年假管理前端页面
  - 文件：`frontend/src/pages/Leave/AnnualLeaveList.tsx`
  - 列表展示：员工姓名、年度、应休、已休、剩余
  - 筛选：按年度、部门、员工
  - 统计图表：部门年假使用率

- [ ] 实现年假自动计算
  - 入职满一年自动生成年假记录
  - 根据工龄计算年假天数（可配置规则）
  - 年假跨年处理
  - 离职时年假清算

- [ ] 权限控制
  - admin/hr_admin：查看所有、编辑
  - department_manager：查看本部门
  - employee：查看个人年假

#### 12.2 社保公积金管理模块 📅 待开始

**优先级**: 高 | **依赖**: 员工管理

- [ ] 设计social_security表结构
  - 字段：记录ID、员工ID、年月、社保基数、公积金基数
  - 缴纳金额：养老保险、医疗保险、失业保险、工伤保险、生育保险、公积金
  - 个人部分、公司部分（分开存储）
  - 缴纳状态：pending/paid/failed

- [ ] 实现社保公积金API
  - GET /api/social-security - 获取记录列表
  - GET /api/social-security/:id - 获取单条记录
  - POST /api/social-security/batch - 批量导入本月数据
  - PUT /api/social-security/:id - 更新记录
  - GET /api/social-security/employee/:employeeId - 查询员工记录
  - POST /api/social-security/calculate - 自动计算缴纳金额

- [ ] 创建社保公积金管理页面
  - 文件：`frontend/src/pages/SocialSecurity/SocialSecurityList.tsx`
  - 月度视图：当月所有员工缴纳情况
  - 员工视图：单个员工历史记录
  - 批量导入：Excel导入本月数据
  - 统计报表：本月缴纳总额、同比环比

- [ ] 实现自动计算功能
  - 根据基数和比例自动计算
  - 支持自定义缴纳比例（可配置）
  - 特殊人员处理（试用期、离职）

- [ ] 实现钉钉推送通知
  - 每月自动推送社保缴纳情况
  - 个人缴纳明细通知
  - 异常情况提醒

- [ ] 权限控制
  - admin/hr_admin：查看所有、编辑、导入
  - department_manager：查看本部门
  - employee：仅查看个人记录

#### 12.3 出差补助管理模块 📅 待开始

**优先级**: 中 | **依赖**: 员工管理

- [ ] 设计business_trip_allowance表结构
  - 字段：补助ID、员工ID、出差日期、目的地、天数
  - 补助类型：交通补助、住宿补助、餐费补助
  - 补助金额、申请状态、审批人、审批时间
  - 附件：票据扫描件

- [ ] 实现出差补助API
  - GET /api/business-trip - 获取补助列表
  - POST /api/business-trip - 申请出差补助
  - PUT /api/business-trip/:id - 更新补助记录
  - POST /api/business-trip/:id/approve - 审批补助
  - GET /api/business-trip/statistics - 月度统计

- [ ] 创建出差补助管理页面
  - 文件：`frontend/src/pages/BusinessTrip/BusinessTripList.tsx`
  - 员工端：申请表单、我的出差记录
  - 管理端：待审批列表、已审批列表
  - 统计视图：月度补助总额、部门排行

- [ ] 实现审批流程
  - 提交申请 → 部门经理审批 → HR审核 → 财务发放
  - 支持驳回和修改
  - 审批通知（钉钉）

- [ ] 实现月度统计推送
  - 每月1日自动统计上月出差补助
  - 推送给财务和HR
  - 生成补助明细Excel

- [ ] 权限控制
  - employee：申请、查看个人记录
  - department_manager：审批本部门申请
  - hr_admin：查看所有、HR审核
  - admin：全部权限

#### 12.4 就餐管理模块 📅 待开始

**优先级**: 低 | **依赖**: 员工管理、考勤管理

- [ ] 设计canteen_meal表结构
  - 字段：记录ID、员工ID、就餐日期、餐次（早/中/晚）
  - 就餐地点：公司食堂/外部餐厅
  - 餐费金额、支付方式
  - 是否补贴、补贴金额

- [ ] 实现就餐记录API
  - GET /api/canteen-meal - 获取就餐记录
  - POST /api/canteen-meal - 记录就餐
  - POST /api/canteen-meal/batch-import - 批量导入（刷卡数据）
  - GET /api/canteen-meal/statistics - 月度统计

- [ ] 创建就餐管理页面
  - 文件：`frontend/src/pages/Canteen/CanteenMealList.tsx`
  - 日视图：今日就餐人员列表
  - 月视图：本月就餐统计
  - 批量导入：食堂刷卡数据导入
  - 统计图表：就餐人数趋势、餐费统计

- [ ] 实现与考勤联动
  - 根据考勤记录自动判断就餐
  - 出差/请假不计入就餐
  - 异常就餐提醒（非工作日）

- [ ] 实现月度工资统计推送
  - 每月1日统计上月食堂工资
  - 计算补贴金额
  - 推送给财务

- [ ] 权限控制
  - admin/hr_admin：查看所有、批量导入
  - department_manager：查看本部门统计
  - employee：查看个人就餐记录

#### 12.5 Excel导入导出增强 📅 待开始

**优先级**: 中 | **依赖**: 各模块API完成

- [ ] 为每个模块创建Excel模板
  - 年假导入模板
  - 社保公积金导入模板
  - 出差补助导入模板
  - 就餐记录导入模板

- [ ] 实现通用导入导出服务
  - 文件：`backend/src/services/ExcelImportExportService.js`
  - 通用导入逻辑（字段映射、验证、批量插入）
  - 通用导出逻辑（数据格式化、样式设置）
  - 错误处理和报告

- [ ] 为所有模块添加导入导出功能
  - 员工管理：✅ 已完成
  - 考勤记录：添加导入导出
  - 年假记录：添加导入导出
  - 社保公积金：添加导入导出
  - 出差补助：添加导出
  - 就餐记录：添加导入

---

### 阶段十三：数据整合Dashboard增强 📅 待开始

**估时**：3-4天 | **优先级**: 高 | **依赖**: 各数据模块完成
**目标**：打造统一的数据展示面板，多维度呈现HR数据

#### 13.1 综合统计卡片 📅 待开始

**优先级**: 高 | **依赖**: 基础数据模块

- [ ] 员工统计卡片增强
  - 在职员工总数（按状态分类）
  - 本月新入职人数
  - 本月离职人数
  - 试用期员工数
  - 环比增长率

- [ ] 考勤统计卡片
  - 今日出勤率
  - 本月迟到/早退人次
  - 本月缺勤人次
  - 本月平均出勤率
  - 同比对比

- [ ] 假期统计卡片
  - 本月请假总天数
  - 待审批假期申请
  - 年假使用率
  - 假期类型分布

- [ ] 财务统计卡片（可选）
  - 本月社保公积金总额
  - 本月出差补助总额
  - 本月食堂补贴总额
  - 环比变化

#### 13.2 可视化图表组件 📅 待开始

**优先级**: 高 | **依赖**: 数据统计API

- [ ] 部门人员分布图
  - 饼图/环形图：各部门人数占比
  - 柱状图：部门人数对比
  - 支持点击钻取到部门详情

- [ ] 入职离职趋势图
  - 折线图：过去12个月入职/离职人数
  - 堆叠区域图：累计人数变化
  - 数据点hover显示详情

- [ ] 考勤状况分析图
  - 折线图：本月每日出勤率
  - 热力图：考勤异常分布（按部门）
  - 柱状图：迟到早退Top10员工

- [ ] 假期使用分析图
  - 柱状图：各类假期使用天数
  - 饼图：假期类型占比
  - 散点图：部门年假使用率对比

- [ ] 社保公积金趋势图（可选）
  - 折线图：过去12个月缴纳总额
  - 堆叠柱状图：个人vs公司部分
  - 同比环比对比

#### 13.3 快捷操作面板 📅 待开始

**优先级**: 中 | **依赖**: 功能模块完成

- [ ] 常用功能快捷入口
  - 新增员工
  - 导入员工信息
  - 查看待审批事项
  - 发送通知
  - 查看考勤异常

- [ ] 待办事项提醒
  - 待审批假期申请（数量徽章）
  - 待审批出差补助
  - 合同即将到期员工
  - 试用期即将结束员工
  - 入职流程超时提醒

- [ ] 最近操作记录
  - 最近新增的员工
  - 最近的审批记录
  - 最近的数据导入
  - 支持快速跳转

#### 13.4 个性化Dashboard配置 📅 待开始

**优先级**: 低 | **依赖**: Dashboard基础完成

- [ ] 卡片拖拽排序
  - 支持拖拽调整卡片位置
  - 保存个性化布局（LocalStorage或后端）
  - 重置为默认布局

- [ ] 卡片显示/隐藏
  - 自定义显示哪些统计卡片
  - 保存配置
  - 不同角色默认配置不同

- [ ] 数据刷新策略
  - 自动刷新（可配置间隔）
  - 手动刷新按钮
  - 最后更新时间显示

#### 13.5 移动端Dashboard优化 📅 待开始

**优先级**: 中 | **依赖**: Dashboard基础完成

- [ ] 响应式布局优化
  - 移动端卡片垂直排列
  - 图表自适应尺寸
  - 触摸友好的交互

- [ ] 移动端快捷操作
  - 一键审批
  - 快速查看详情
  - 下拉刷新数据

- [ ] 钉钉工作台集成
  - 在钉钉工作台显示核心数据
  - 微应用跳转
  - 消息通知集成

#### 13.6 Dashboard API开发 📅 待开始

**优先级**: 高 | **依赖**: 各模块数据

- [ ] 综合统计API
  - GET /api/dashboard/overview - 获取概览数据
  - GET /api/dashboard/employee-stats - 员工统计
  - GET /api/dashboard/attendance-stats - 考勤统计
  - GET /api/dashboard/leave-stats - 假期统计
  - GET /api/dashboard/financial-stats - 财务统计（可选）

- [ ] 图表数据API
  - GET /api/dashboard/charts/department-distribution - 部门分布
  - GET /api/dashboard/charts/hiring-trend - 入职离职趋势
  - GET /api/dashboard/charts/attendance-analysis - 考勤分析
  - GET /api/dashboard/charts/leave-analysis - 假期分析

- [ ] 待办事项API
  - GET /api/dashboard/pending-approvals - 待审批事项
  - GET /api/dashboard/alerts - 提醒事项
  - GET /api/dashboard/recent-activities - 最近操作

- [ ] 权限控制
  - admin/hr_admin：查看全部统计
  - department_manager：查看本部门统计
  - employee：查看个人相关数据

---

## 📝 更新日志

### 版本 2.1.0 (2025-12-04)
- 添加阶段十一：智能体问答系统（悬浮窗口交互）
- 添加阶段十二：其他业务数据表管理（年假、社保、出差、就餐）
- 添加阶段十三：数据整合Dashboard增强
- 根据项目需求说明书完善功能规划
- 新增功能模块：
  - 知识库管理和智能问答引擎
  - 前端悬浮聊天窗口
  - 年假、社保公积金、出差补助、就餐记录管理
  - Dashboard数据可视化增强

### 版本 2.0.0 (2025-01-09)
- 完全重构requirement.md文档
- 添加详细的进度跟踪
- 添加风险评估和成功标准
- 添加问题追踪系统

### 版本 1.0.0 (2025-01-08)
- 初始需求文档
- 基础功能点列表

---

**文档维护**: 每次开发完成后必须更新相应功能点状态和完成时间
**审阅周期**: 每周审阅一次，更新进度和调整计划
