name: ğŸš€ Deploy to Aliyun ECS

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'ğŸ–¥ï¸ éƒ¨ç½²åç«¯æœåŠ¡'
        required: false
        type: boolean
        default: false
      deploy_frontend:
        description: 'ğŸŒ éƒ¨ç½²å‰ç«¯æœåŠ¡'
        required: false
        type: boolean
        default: false
      deploy_all:
        description: 'ğŸš€ éƒ¨ç½²æ‰€æœ‰æœåŠ¡ (ä¼˜å…ˆçº§æœ€é«˜)'
        required: false
        type: boolean
        default: true
      skip_cache:
        description: 'âŒ è·³è¿‡æ„å»ºç¼“å­˜'
        required: false
        type: boolean
        default: false

env:
  ACR_REPOSITORY_BACKEND: hrsystem-backend
  ACR_REPOSITORY_FRONTEND: hrsystem-frontend
  BACKEND_PORT: 3001
  FRONTEND_PORT: 80

jobs:
  # 1. æ£€æµ‹å˜æ›´å’Œé…ç½®
  prepare:
    name: ğŸ“‹ å‡†å¤‡å’Œæ£€æµ‹
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      should_deploy_backend: ${{ steps.deployment_logic.outputs.should_deploy_backend }}
      should_deploy_frontend: ${{ steps.deployment_logic.outputs.should_deploy_frontend }}
      use_cache: ${{ steps.deployment_logic.outputs.use_cache }}
      image_tag: ${{ steps.deployment_logic.outputs.image_tag }}
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'backend/Dockerfile'
            frontend:
              - 'frontend/**'
              - 'frontend/Dockerfile'
            shared:
              - '**/package.json'
              - '.github/workflows/deploy.yml'

      - name: ğŸ§  éƒ¨ç½²é€»è¾‘å†³ç­–
        id: deployment_logic
        run: |
          MANUAL_BACKEND="${{ github.event.inputs.deploy_backend }}"
          MANUAL_FRONTEND="${{ github.event.inputs.deploy_frontend }}"
          MANUAL_ALL="${{ github.event.inputs.deploy_all }}"
          SKIP_CACHE="${{ github.event.inputs.skip_cache }}"

          CHANGED_BACKEND="${{ steps.filter.outputs.backend }}"
          CHANGED_FRONTEND="${{ steps.filter.outputs.frontend }}"
          CHANGED_SHARED="${{ steps.filter.outputs.shared }}"

          # ä¼˜å…ˆçº§ï¼šæ‰‹åŠ¨éƒ¨ç½²æ‰€æœ‰ > æ‰‹åŠ¨æŒ‡å®š > è‡ªåŠ¨æ£€æµ‹
          if [[ "$MANUAL_ALL" == "true" ]]; then
            echo "should_deploy_backend=true" >> $GITHUB_OUTPUT
            echo "should_deploy_frontend=true" >> $GITHUB_OUTPUT
          elif [[ "$MANUAL_BACKEND" == "true" ]] || [[ "$MANUAL_FRONTEND" == "true" ]]; then
            echo "should_deploy_backend=$MANUAL_BACKEND" >> $GITHUB_OUTPUT
            echo "should_deploy_frontend=$MANUAL_FRONTEND" >> $GITHUB_OUTPUT
          else
            # å…±äº«é…ç½®å˜æ›´æ—¶åŒæ—¶éƒ¨ç½²å‰åç«¯
            if [[ "$CHANGED_SHARED" == "true" ]]; then
              echo "should_deploy_backend=true" >> $GITHUB_OUTPUT
              echo "should_deploy_frontend=true" >> $GITHUB_OUTPUT
            else
              echo "should_deploy_backend=$CHANGED_BACKEND" >> $GITHUB_OUTPUT
              echo "should_deploy_frontend=$CHANGED_FRONTEND" >> $GITHUB_OUTPUT
            fi
          fi

          echo "use_cache=true" >> $GITHUB_OUTPUT
          if [[ "$SKIP_CACHE" == "true" ]]; then
            echo "use_cache=false" >> $GITHUB_OUTPUT
          fi

          IMAGE_TAG=$(git rev-parse --short HEAD)
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“Š ç¯å¢ƒä¿¡æ¯å±•ç¤º
        run: |
          echo "ğŸ”§ éƒ¨ç½²å†³ç­–ç»“æœ:"
          echo "  - éƒ¨ç½²åç«¯: ${{ steps.deployment_logic.outputs.should_deploy_backend }}"
          echo "  - éƒ¨ç½²å‰ç«¯: ${{ steps.deployment_logic.outputs.should_deploy_frontend }}"
          echo "  - ä½¿ç”¨ç¼“å­˜: ${{ steps.deployment_logic.outputs.use_cache }}"
          echo "  - é•œåƒæ ‡ç­¾: ${{ steps.deployment_logic.outputs.image_tag }}"

  # 2. æ„å»ºå’Œæ¨é€é•œåƒ
  build-and-push:
    name: ğŸ—ï¸ æ„å»ºå’Œæ¨é€é•œåƒ
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ needs.prepare.outputs.should_deploy_backend == 'true' || needs.prepare.outputs.should_deploy_frontend == 'true' }}
    permissions:
      contents: read
      packages: write
    outputs:
      backend_image: ${{ steps.image_info.outputs.backend_image }}
      frontend_image: ${{ steps.image_info.outputs.frontend_image }}

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½• ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login \
            --username "${{ secrets.ACR_USERNAME }}" \
            --password-stdin \
            "${{ secrets.ACR_REGISTRY }}"

      # æ„å»ºå’Œæ¨é€åç«¯é•œåƒ
      - name: ğŸ—ï¸ æ„å»ºå’Œæ¨é€åç«¯é•œåƒ
        if: ${{ needs.prepare.outputs.should_deploy_backend == 'true' }}
        env:
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
        run: |
          cd backend

          FULL_IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ env.ACR_REPOSITORY_BACKEND }}:${IMAGE_TAG}"
          LATEST_IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ env.ACR_REPOSITORY_BACKEND }}:latest"

          if [[ "${{ needs.prepare.outputs.use_cache }}" == "true" ]]; then
            docker buildx build \
              --platform linux/amd64 \
              --cache-from type=registry,ref=${LATEST_IMAGE} \
              --cache-to type=inline \
              --tag ${FULL_IMAGE} \
              --tag ${LATEST_IMAGE} \
              --push . || {
              echo "âš ï¸ Buildx å¤±è´¥ï¼Œä½¿ç”¨ä¼ ç»Ÿæ„å»º"
              docker build --tag ${FULL_IMAGE} --tag ${LATEST_IMAGE} .
              docker push ${FULL_IMAGE}
              docker push ${LATEST_IMAGE}
            }
          else
            docker build --tag ${FULL_IMAGE} --tag ${LATEST_IMAGE} .
            docker push ${FULL_IMAGE}
            docker push ${LATEST_IMAGE}
          fi

          echo "âœ… Backend image pushed: ${FULL_IMAGE}"

      # æ„å»ºå’Œæ¨é€å‰ç«¯é•œåƒ
      - name: ğŸŒ æ„å»ºå’Œæ¨é€å‰ç«¯é•œåƒ
        if: ${{ needs.prepare.outputs.should_deploy_frontend == 'true' }}
        env:
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
          REACT_APP_API_URL: ${{ secrets.BACKEND_API_URL }}
        run: |
          cd frontend

          FULL_IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ env.ACR_REPOSITORY_FRONTEND }}:${IMAGE_TAG}"
          LATEST_IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ env.ACR_REPOSITORY_FRONTEND }}:latest"

          if [[ "${{ needs.prepare.outputs.use_cache }}" == "true" ]]; then
            docker buildx build \
              --platform linux/amd64 \
              --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} \
              --cache-from type=registry,ref=${LATEST_IMAGE} \
              --cache-to type=inline \
              --tag ${FULL_IMAGE} \
              --tag ${LATEST_IMAGE} \
              --push . || {
              echo "âš ï¸ Buildx å¤±è´¥ï¼Œä½¿ç”¨ä¼ ç»Ÿæ„å»º"
              docker build \
                --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} \
                --tag ${FULL_IMAGE} \
                --tag ${LATEST_IMAGE} .
              docker push ${FULL_IMAGE}
              docker push ${LATEST_IMAGE}
            }
          else
            docker build \
              --build-arg REACT_APP_API_URL=${REACT_APP_API_URL} \
              --tag ${FULL_IMAGE} \
              --tag ${LATEST_IMAGE} .
            docker push ${FULL_IMAGE}
            docker push ${LATEST_IMAGE}
          fi

          echo "âœ… Frontend image pushed: ${FULL_IMAGE}"

      - name: ğŸ“ è¾“å‡ºé•œåƒä¿¡æ¯
        id: image_info
        env:
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
        run: |
          if [[ "${{ needs.prepare.outputs.should_deploy_backend }}" == "true" ]]; then
            BACKEND_IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ env.ACR_REPOSITORY_BACKEND }}:${IMAGE_TAG}"
            echo "backend_image=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT
          fi

          if [[ "${{ needs.prepare.outputs.should_deploy_frontend }}" == "true" ]]; then
            FRONTEND_IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ env.ACR_REPOSITORY_FRONTEND }}:${IMAGE_TAG}"
            echo "frontend_image=${FRONTEND_IMAGE}" >> $GITHUB_OUTPUT
          fi

  # 3. éƒ¨ç½²åˆ° ECS
  deploy-to-ecs:
    name: ğŸš€ éƒ¨ç½²åˆ° ECS
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    if: ${{ needs.build-and-push.result == 'success' }}

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” é…ç½® SSH å¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ECS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.BACKEND_ECS_IPS }} >> ~/.ssh/known_hosts || true
          ssh-keyscan -H ${{ secrets.FRONTEND_ECS_IPS }} >> ~/.ssh/known_hosts || true

      - name: ğŸ–¥ï¸ éƒ¨ç½²åç«¯åˆ° ECS
        if: ${{ needs.prepare.outputs.should_deploy_backend == 'true' }}
        env:
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
          BACKEND_IMAGE: ${{ needs.build-and-push.outputs.backend_image }}
        run: |
          BACKEND_IPS="${{ secrets.BACKEND_ECS_IPS }}"

          for IP in ${BACKEND_IPS//,/ }; do
            echo "ğŸš€ éƒ¨ç½²åç«¯åˆ° ECS: $IP"

            ssh -o StrictHostKeyChecking=no root@$IP << 'ENDSSH'
              # ç™»å½• ACR
              echo "${{ secrets.ACR_PASSWORD }}" | docker login \
                --username "${{ secrets.ACR_USERNAME }}" \
                --password-stdin \
                "${{ secrets.ACR_REGISTRY }}"

              # æ‹‰å–æ–°é•œåƒ
              docker pull ${{ needs.build-and-push.outputs.backend_image }}

              # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
              docker stop hrsystem-backend || true
              docker rm hrsystem-backend || true

              # å¯åŠ¨æ–°å®¹å™¨
              docker run -d \
                --name hrsystem-backend \
                --restart unless-stopped \
                -p ${{ env.BACKEND_PORT }}:3001 \
                -e NODE_ENV=production \
                -e PORT=3001 \
                -e DB_HOST=${{ secrets.DB_HOST }} \
                -e DB_PORT=${{ secrets.DB_PORT }} \
                -e DB_NAME=${{ secrets.DB_NAME }} \
                -e DB_USER=${{ secrets.DB_USER }} \
                -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                -e REDIS_HOST=${{ secrets.REDIS_HOST }} \
                -e REDIS_PORT=${{ secrets.REDIS_PORT }} \
                -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
                -e ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }} \
                -e FRONTEND_URL=${{ secrets.BACKEND_API_URL }} \
                ${{ needs.build-and-push.outputs.backend_image }}

              # æ¸…ç†æ—§é•œåƒ
              docker image prune -af --filter "until=24h"

              # éªŒè¯éƒ¨ç½²
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
              sleep 10
              if curl -f http://localhost:${{ env.BACKEND_PORT }}/health; then
                echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸåœ¨ $IP"
              else
                echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥åœ¨ $IP"
                docker logs hrsystem-backend --tail 50
                exit 1
              fi
          ENDSSH

            if [ $? -eq 0 ]; then
              echo "âœ… åç«¯æˆåŠŸéƒ¨ç½²åˆ° $IP"
            else
              echo "âŒ åç«¯éƒ¨ç½²å¤±è´¥åˆ° $IP"
              exit 1
            fi
          done

      - name: ğŸŒ éƒ¨ç½²å‰ç«¯åˆ° ECS
        if: ${{ needs.prepare.outputs.should_deploy_frontend == 'true' }}
        env:
          IMAGE_TAG: ${{ needs.prepare.outputs.image_tag }}
          FRONTEND_IMAGE: ${{ needs.build-and-push.outputs.frontend_image }}
        run: |
          FRONTEND_IPS="${{ secrets.FRONTEND_ECS_IPS }}"

          for IP in ${FRONTEND_IPS//,/ }; do
            echo "ğŸš€ éƒ¨ç½²å‰ç«¯åˆ° ECS: $IP"

            ssh -o StrictHostKeyChecking=no root@$IP << 'ENDSSH'
              # ç™»å½• ACR
              echo "${{ secrets.ACR_PASSWORD }}" | docker login \
                --username "${{ secrets.ACR_USERNAME }}" \
                --password-stdin \
                "${{ secrets.ACR_REGISTRY }}"

              # æ‹‰å–æ–°é•œåƒ
              docker pull ${{ needs.build-and-push.outputs.frontend_image }}

              # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
              docker stop hrsystem-frontend || true
              docker rm hrsystem-frontend || true

              # å¯åŠ¨æ–°å®¹å™¨
              docker run -d \
                --name hrsystem-frontend \
                --restart unless-stopped \
                -p ${{ env.FRONTEND_PORT }}:80 \
                ${{ needs.build-and-push.outputs.frontend_image }}

              # æ¸…ç†æ—§é•œåƒ
              docker image prune -af --filter "until=24h"

              # éªŒè¯éƒ¨ç½²
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
              sleep 5
              if curl -f http://localhost/; then
                echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸåœ¨ $IP"
              else
                echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥åœ¨ $IP"
                docker logs hrsystem-frontend --tail 50
                exit 1
              fi
          ENDSSH

            if [ $? -eq 0 ]; then
              echo "âœ… å‰ç«¯æˆåŠŸéƒ¨ç½²åˆ° $IP"
            else
              echo "âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥åˆ° $IP"
              exit 1
            fi
          done

      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          mkdir -p deployment-manifests

          cat > deployment-manifests/deployment-summary.md << EOF
          # ğŸš€ éƒ¨ç½²æˆåŠŸæ‘˜è¦

          **éƒ¨ç½²æ—¶é—´**: $(date)
          **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          **é•œåƒæ ‡ç­¾**: ${{ needs.prepare.outputs.image_tag }}

          ## ğŸ“‹ æœåŠ¡éƒ¨ç½²æƒ…å†µ

          | æœåŠ¡ | çŠ¶æ€ | é•œåƒåœ°å€ |
          |------|------|----------|
          | åç«¯æœåŠ¡ | ${{ needs.prepare.outputs.should_deploy_backend == 'true' && 'ğŸŸ¢ å·²éƒ¨ç½²' || 'â­• æœªéƒ¨ç½²' }} | ${{ needs.build-and-push.outputs.backend_image || 'N/A' }} |
          | å‰ç«¯æœåŠ¡ | ${{ needs.prepare.outputs.should_deploy_frontend == 'true' && 'ğŸŸ¢ å·²éƒ¨ç½²' || 'â­• æœªéƒ¨ç½²' }} | ${{ needs.build-and-push.outputs.frontend_image || 'N/A' }} |

          ## ğŸ”§ ç¯å¢ƒä¿¡æ¯

          - **ACR æ³¨å†Œè¡¨**: \`${{ secrets.ACR_REGISTRY }}\`
          - **å‘½åç©ºé—´**: \`${{ secrets.ACR_NAMESPACE }}\`
          - **åç«¯ ECS**: \`${{ secrets.BACKEND_ECS_IPS }}\`
          - **å‰ç«¯ ECS**: \`${{ secrets.FRONTEND_ECS_IPS }}\`
          - **åç«¯ç«¯å£**: \`${{ env.BACKEND_PORT }}\`
          - **å‰ç«¯ç«¯å£**: \`${{ env.FRONTEND_PORT }}\`

          ## ğŸ“ˆ ä¸‹ä¸€æ­¥æ“ä½œ

          1. âœ… éªŒè¯æœåŠ¡å¥åº·çŠ¶æ€
          2. ğŸ“Š æ£€æŸ¥åº”ç”¨æ—¥å¿—
          3. ğŸ§ª è¿è¡Œå†’çƒŸæµ‹è¯•
          4. ğŸ“± æµ‹è¯•å‰åç«¯è¿æ¥

          ## ğŸ”— è®¿é—®åœ°å€

          - **åç«¯ API**: \`${{ secrets.BACKEND_API_URL }}\`
          - **å‰ç«¯åº”ç”¨**: é€šè¿‡è´Ÿè½½å‡è¡¡å™¨è®¿é—®

          ---
          *Generated by GitHub Actions - Run #${{ github.run_number }}*
          EOF

          cat deployment-manifests/deployment-summary.md

      - name: ğŸ“¦ å½’æ¡£éƒ¨ç½²æ‘˜è¦
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-summary-${{ github.run_number }}
          path: deployment-manifests/
          retention-days: 30

      - name: ğŸ¯ æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"
            echo "âœ… åç«¯éƒ¨ç½²: ${{ needs.prepare.outputs.should_deploy_backend }}"
            echo "âœ… å‰ç«¯éƒ¨ç½²: ${{ needs.prepare.outputs.should_deploy_frontend }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi
