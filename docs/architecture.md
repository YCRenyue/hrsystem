# 系统架构设计文档

## 1. 总体架构

### 1.1 架构概览
人事管理系统采用微服务架构，支持云原生部署，具备高可用、高扩展性和高性能特征。

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户接入层                               │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   Web前端       │   移动端H5      │      钉钉工作台           │
│  (React/Vue)    │  (响应式适配)   │   (钉钉小程序/H5)         │
└─────────────────┴─────────────────┴─────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                       API网关层                                │
│              Nginx/Kong (负载均衡、限流、鉴权)                 │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                       业务服务层                               │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  用户认证服务   │   员工管理服务  │      智能问答服务          │
│  (Auth Service) │(Employee Service)│   (AI Chat Service)        │
├─────────────────┼─────────────────┼─────────────────────────────┤
│  考勤管理服务   │   报表分析服务  │      消息推送服务          │
│(Attendance Svc) │ (Report Service)│ (Notification Service)     │
├─────────────────┼─────────────────┼─────────────────────────────┤
│  文件管理服务   │   工作流引擎    │      钉钉集成服务          │
│ (File Service)  │(Workflow Engine)│  (DingTalk Service)        │
└─────────────────┴─────────────────┴─────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                       数据存储层                               │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   MySQL集群     │   Redis缓存     │       文件存储             │
│  (主从复制)     │   (分布式)      │    (OSS/MinIO)             │
├─────────────────┼─────────────────┼─────────────────────────────┤
│   消息队列      │   搜索引擎      │       监控系统             │
│ (RabbitMQ/Kafka)│ (Elasticsearch) │  (Prometheus+Grafana)      │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

### 1.2 架构特点

#### 微服务架构
- **服务拆分**：按业务领域拆分为独立的微服务
- **独立部署**：每个服务可独立开发、测试、部署
- **技术栈灵活**：不同服务可选择合适的技术栈
- **故障隔离**：单个服务故障不影响整体系统

#### 云原生设计
- **容器化部署**：基于Docker容器化部署
- **容器编排**：使用Kubernetes进行容器管理
- **弹性伸缩**：支持根据负载自动扩容缩容
- **服务发现**：自动服务注册与发现

#### 数据一致性
- **分布式事务**：使用Saga模式处理跨服务事务
- **事件驱动**：基于事件的异步通信机制
- **最终一致性**：确保数据最终一致性

## 2. 核心服务设计

### 2.1 用户认证服务 (Auth Service)
- **功能职责**：
  - 钉钉OAuth认证
  - JWT Token生成和验证
  - 用户权限管理
  - 会话管理

- **技术栈**：Node.js + Express + Redis
- **数据库**：用户表、权限表、会话表

### 2.2 员工管理服务 (Employee Service)
- **功能职责**：
  - 员工信息CRUD
  - Excel批量导入
  - 入职流程管理
  - 数据加密解密

- **技术栈**：Java + Spring Boot + MyBatis
- **数据库**：员工表、部门表、入职流程表

### 2.3 智能问答服务 (AI Chat Service)
- **功能职责**：
  - 自然语言处理
  - 知识库查询
  - 语音识别
  - 智能回复生成

- **技术栈**：Python + FastAPI + transformers
- **AI模型**：BERT、GPT、语音识别模型

### 2.4 消息推送服务 (Notification Service)
- **功能职责**：
  - 钉钉消息推送
  - 短信发送
  - 邮件通知
  - 消息模板管理

- **技术栈**：Node.js + Express + Queue
- **第三方集成**：钉钉API、阿里云短信、SMTP

## 3. 数据架构

### 3.1 数据分层
```
┌─────────────────────────────────────────┐
│              应用数据层                 │
│        (Application Data Layer)         │
├─────────────────────────────────────────┤
│              逻辑数据层                 │
│          (Logical Data Layer)           │
├─────────────────────────────────────────┤
│              物理数据层                 │
│         (Physical Data Layer)           │
└─────────────────────────────────────────┘
```

### 3.2 数据分库分表策略
- **垂直分库**：按业务模块分库
  - hr_employee_db：员工管理相关
  - hr_attendance_db：考勤管理相关
  - hr_report_db：报表分析相关

- **水平分表**：按数据量分表
  - 操作日志表按月分表
  - 考勤记录表按年分表

### 3.3 数据安全策略
- **加密存储**：敏感字段AES-256加密
- **访问控制**：基于角色的数据访问控制
- **审计日志**：完整的数据操作审计
- **备份策略**：定期自动备份和容灾恢复

## 4. 技术选型

### 4.1 前端技术栈
- **框架**：React 18.x + TypeScript
- **状态管理**：Redux Toolkit + RTK Query
- **UI组件**：Ant Design 5.x
- **构建工具**：Vite + ESBuild
- **代码规范**：ESLint + Prettier + Husky

### 4.2 后端技术栈
- **用户服务**：Node.js + Express + TypeScript
- **业务服务**：Java 17 + Spring Boot 3.x
- **AI服务**：Python 3.9+ + FastAPI + PyTorch
- **数据库**：MySQL 8.0 + Redis 6.x
- **消息队列**：RabbitMQ 3.x

### 4.3 基础设施
- **容器化**：Docker + Docker Compose
- **编排**：Kubernetes 1.24+
- **服务网格**：Istio (可选)
- **监控**：Prometheus + Grafana + Jaeger
- **日志**：ELK Stack (Elasticsearch + Logstash + Kibana)

## 5. 部署架构

### 5.1 环境规划
```
开发环境 (Development)
├── 本地开发环境
├── Docker Compose
└── 热重载调试

测试环境 (Testing)
├── 功能测试环境
├── 性能测试环境
└── 集成测试环境

生产环境 (Production)
├── Kubernetes集群
├── 高可用部署
└── 监控告警系统
```

### 5.2 CI/CD流程
```
代码提交 → 自动构建 → 单元测试 → 代码扫描 → 构建镜像 → 部署测试 → 部署生产
    ↓           ↓         ↓         ↓         ↓         ↓         ↓
  Git Push   Jenkins    Jest      SonarQube  Docker   K8s Test  K8s Prod
```

### 5.3 监控体系
- **基础监控**：服务器资源监控
- **应用监控**：应用性能监控(APM)
- **业务监控**：关键业务指标监控
- **日志监控**：集中日志收集和分析
- **告警系统**：多渠道告警通知

## 6. 安全架构

### 6.1 网络安全
- **HTTPS**：全站SSL加密传输
- **WAF**：Web应用防火墙
- **DDoS防护**：分布式拒绝服务攻击防护
- **IP白名单**：关键接口IP访问控制

### 6.2 应用安全
- **身份认证**：OAuth 2.0 + JWT
- **权限控制**：RBAC基于角色的访问控制
- **数据加密**：敏感数据AES加密存储
- **SQL注入防护**：参数化查询

### 6.3 数据安全
- **数据脱敏**：敏感信息显示脱敏
- **数据备份**：定期自动备份
- **访问审计**：完整的数据访问日志
- **合规性**：符合数据保护法规要求

## 7. 性能设计

### 7.1 缓存策略
- **Redis缓存**：热点数据缓存
- **CDN加速**：静态资源分发
- **浏览器缓存**：客户端资源缓存
- **数据库查询缓存**：SQL结果缓存

### 7.2 数据库优化
- **索引优化**：合理创建数据库索引
- **查询优化**：SQL语句性能调优
- **读写分离**：主从数据库分离
- **分库分表**：大数据量水平切分

### 7.3 性能指标
- **响应时间**：API响应时间 < 200ms
- **并发处理**：支持1000+并发用户
- **系统吞吐量**：10000+ TPS
- **可用性**：99.9%系统可用率
